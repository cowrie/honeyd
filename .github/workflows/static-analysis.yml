name: Static Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cppcheck:
    name: Cppcheck
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          cmake \
          libevent-dev \
          libpcap-dev \
          libdumbnet-dev \
          libpcre3-dev \
          flex \
          bison \
          libreadline-dev \
          zlib1g-dev \
          python3-dev

    - name: Configure with CMake
      run: |
        mkdir -p build
        cd build
        cmake ..

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,performance,portability --error-exitcode=1 \
          --inline-suppr \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unknownMacro \
          --suppress=syntaxError \
          --suppress=uninitvar \
          -DHAVE_PYTHON=1 \
          -I build \
          -i dpkt \
          -i pypcap \
          -i build \
          -i regress \
          -i subsystems \
          -i webserver \
          .

  clang-tidy:
    name: Clang-Tidy
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-tidy \
          cmake \
          libevent-dev \
          libpcap-dev \
          libdumbnet-dev \
          libpcre3-dev \
          flex \
          bison \
          libreadline-dev \
          zlib1g-dev \
          python3-dev

    - name: Configure with CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Run clang-tidy
      run: |
        cd build
        # Get list of source files
        find .. -name "*.c" ! -path "../build/*" ! -path "../dpkt/*" ! -path "../pypcap/*" > files.txt

        # Run clang-tidy on each file
        # Disable concurrency-mt-unsafe: honeyd is single-threaded
        cat files.txt | xargs -I {} clang-tidy -p . \
          -checks='-concurrency-mt-unsafe' {}
