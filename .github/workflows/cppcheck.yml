name: Cppcheck

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cppcheck:
    name: Static Analysis with Cppcheck
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        set -o pipefail
        cppcheck \
          --enable=warning,style,performance,portability \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --inline-suppr \
          --template='{file}:{line}:{severity}:{message}' \
          --error-exitcode=1 \
          -I . \
          -I build \
          -i build \
          -i compat \
          -i dpkt \
          -i pypcap \
          -i webserver \
          . 2>&1 | tee cppcheck-report.txt

        # Check for error-level issues
        if grep -q ":error:" cppcheck-report.txt; then
          echo "::error::Cppcheck found errors"
          grep ":error:" cppcheck-report.txt
          exit 1
        fi
        echo "Cppcheck completed successfully"

    - name: Upload cppcheck report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck-report.txt
