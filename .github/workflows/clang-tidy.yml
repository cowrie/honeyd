name: Clang-Tidy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  clang-tidy:
    name: Clang-Tidy Analysis
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-tidy \
          cmake \
          libevent-dev \
          libdumbnet-dev \
          libpcap-dev \
          libreadline-dev \
          zlib1g-dev \
          bison \
          flex

    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Run clang-tidy
      run: |
        set -o pipefail
        echo "Running clang-tidy on C source files..."
        echo "========================================"

        # Run clang-tidy on all C source files
        find . -name '*.c' \
          -not -path './build/*' \
          -not -path './compat/*' \
          -not -path './dpkt/*' \
          -not -path './pypcap/*' \
          -not -path './webserver/*' \
          | xargs clang-tidy -p build --warnings-as-errors='' 2>&1 \
          | tee clang-tidy-report.txt

        echo "========================================"
        echo "Clang-tidy analysis complete"

    - name: Show summary and check for errors
      if: always()
      run: |
        echo "Clang-Tidy Summary"
        echo "=================="

        # Count warnings and errors
        ERROR_COUNT=$(grep -c "error:" clang-tidy-report.txt || true)
        WARNING_COUNT=$(grep -c "warning:" clang-tidy-report.txt || true)

        echo "Errors found: $ERROR_COUNT"
        echo "Warnings found: $WARNING_COUNT"
        echo ""

        # Show first 50 issues in the log
        if [ "$ERROR_COUNT" -gt 0 ] || [ "$WARNING_COUNT" -gt 0 ]; then
          echo "First 50 issues:"
          echo "----------------"
          grep -E "(error:|warning:)" clang-tidy-report.txt | head -50 || true
          echo ""

          if [ $(wc -l < clang-tidy-report.txt) -gt 50 ]; then
            echo "(More issues available in the artifact)"
          fi
        fi

        # Fail if there are any error-level issues
        if [ "$ERROR_COUNT" -gt 0 ]; then
          echo "::error::Clang-tidy found $ERROR_COUNT error(s)"
          exit 1
        fi

        echo "Clang-tidy completed successfully (warnings only)"

    - name: Upload clang-tidy report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: clang-tidy-report
        path: clang-tidy-report.txt
